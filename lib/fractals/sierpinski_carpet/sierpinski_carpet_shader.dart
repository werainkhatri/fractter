import 'dart:convert';
import 'dart:typed_data';
import 'dart:ui';

import 'package:umbra_flutter/umbra_flutter.dart';

/// {@template sierpinski_carpet_shader}
/// A Flutter Widget for the `sierpinski_carpet_shader` shader.
/// {@endtemplate}
class SierpinskiCarpetShader extends UmbraWidget {
  /// {@macro sierpinski_carpet_shader}
  const SierpinskiCarpetShader({
    super.key,
    super.blendMode = BlendMode.src,
    super.child,
    super.errorBuilder,
    super.compilingBuilder,
    required double iterations,
    required Vector4 carpetColor,
    required Vector4 backgroundColor,
  })  : _iterations = iterations,
        _carpetColor = carpetColor,
        _backgroundColor = backgroundColor,
        super();

  static Future<FragmentProgram>? _cachedProgram;

  final double _iterations;

  final Vector4 _carpetColor;

  final Vector4 _backgroundColor;

  @override
  List<double> getFloatUniforms() {
    return [
      _iterations,
      _carpetColor.x,
      _carpetColor.y,
      _carpetColor.z,
      _carpetColor.w,
      _backgroundColor.x,
      _backgroundColor.y,
      _backgroundColor.z,
      _backgroundColor.w,
    ];
  }

  @override
  List<ImageShader> getSamplerUniforms() {
    return [];
  }

  @override
  Future<FragmentProgram> program() {
    return _cachedProgram ??
        FragmentProgram.compile(
          spirv: Uint8List.fromList(base64Decode(_spirv)).buffer,
        );
  }
}

const _spirv =
    'AwIjBwAAAQAKAA0AjAAAAAAAAAARAAIAAQAAAAsABgABAAAAR0xTTC5zdGQuNDUwAAAAAA4AAwAAAAAAAQAAAA8ABwAEAAAABAAAAG1haW4AAAAAfQAAAIUAAAAQAAMABAAAAAgAAAADAAMAAQAAAEABAAAEAAoAR0xfR09PR0xFX2NwcF9zdHlsZV9saW5lX2RpcmVjdGl2ZQAABAAIAEdMX0dPT0dMRV9pbmNsdWRlX2RpcmVjdGl2ZQAFAAQABAAAAG1haW4AAAAABQAIAAsAAABzaWVycGluc2tpQ2FycGV0KHZmMjsAAAAFAAMACgAAAHV2AAAFAAcAEQAAAGZyYWdtZW50KHZmMjt2ZjI7AAAABQADAA8AAAB1dgAABQAFABAAAABmcmFnQ29vcmQAAAAFAAQAFAAAAHNjYWxlAAAABQADABoAAABpAAAABQAFAE0AAABpdGVyYXRpb25zAAAFAAMAVQAAAGQAAAAFAAMAZAAAAHV2MgAFAAMAawAAAGQAAAAFAAQAbAAAAHBhcmFtAAAABQAFAHQAAABjYXJwZXRDb2xvcgAFAAYAdwAAAGJhY2tncm91bmRDb2xvcgAFAAMAewAAAHV2AAAFAAYAfQAAAGdsX0ZyYWdDb29yZAAAAAAFAAUAgQAAAHJlc29sdXRpb24AAAUABACFAAAAX0NPTE9SXwAFAAQAhgAAAHBhcmFtAAAABQAEAIgAAABwYXJhbQAAAEcAAwALAAAAAAAAAEcAAwAKAAAAAAAAAEcAAwARAAAAAAAAAEcAAwAPAAAAAAAAAEcAAwAQAAAAAAAAAEcAAwAUAAAAAAAAAEcAAwAWAAAAAAAAAEcAAwAXAAAAAAAAAEcAAwAYAAAAAAAAAEcAAwAZAAAAAAAAAEcAAwAaAAAAAAAAAEcAAwAhAAAAAAAAAEcAAwAlAAAAAAAAAEcAAwAmAAAAAAAAAEcAAwAnAAAAAAAAAEcAAwAoAAAAAAAAAEcAAwApAAAAAAAAAEcAAwAqAAAAAAAAAEcAAwAvAAAAAAAAAEcAAwAwAAAAAAAAAEcAAwAzAAAAAAAAAEcAAwA0AAAAAAAAAEcAAwA1AAAAAAAAAEcAAwA2AAAAAAAAAEcAAwA3AAAAAAAAAEcAAwA4AAAAAAAAAEcAAwA6AAAAAAAAAEcAAwA7AAAAAAAAAEcAAwA8AAAAAAAAAEcAAwA9AAAAAAAAAEcAAwA+AAAAAAAAAEcAAwA/AAAAAAAAAEcAAwBAAAAAAAAAAEcAAwBBAAAAAAAAAEcAAwBDAAAAAAAAAEcAAwBEAAAAAAAAAEcAAwBFAAAAAAAAAEcAAwBGAAAAAAAAAEcAAwBHAAAAAAAAAEcAAwBIAAAAAAAAAEcAAwBJAAAAAAAAAEcAAwBKAAAAAAAAAEcAAwBLAAAAAAAAAEcAAwBNAAAAAAAAAEcABABNAAAAHgAAAAAAAABHAAMATgAAAAAAAABHAAMAUwAAAAAAAABHAAMAVAAAAAAAAABHAAMAVQAAAAAAAABHAAMAVgAAAAAAAABHAAMAVwAAAAAAAABHAAMAWQAAAAAAAABHAAMAWgAAAAAAAABHAAMAWwAAAAAAAABHAAMAXAAAAAAAAABHAAMAXQAAAAAAAABHAAMAXgAAAAAAAABHAAMAXwAAAAAAAABHAAMAYAAAAAAAAABHAAMAYQAAAAAAAABHAAMAZAAAAAAAAABHAAMAZgAAAAAAAABHAAMAaQAAAAAAAABHAAMAagAAAAAAAABHAAMAawAAAAAAAABHAAMAbAAAAAAAAABHAAMAbQAAAAAAAABHAAMAbgAAAAAAAABHAAMAbwAAAAAAAABHAAMAdAAAAAAAAABHAAQAdAAAAB4AAAABAAAARwADAHUAAAAAAAAARwADAHcAAAAAAAAARwAEAHcAAAAeAAAAAgAAAEcAAwB4AAAAAAAAAEcAAwB7AAAAAAAAAEcABAB9AAAACwAAAA8AAABHAAMAgQAAAAAAAABHAAQAgQAAAB4AAAADAAAARwADAIIAAAAAAAAARwADAIUAAAAAAAAARwAEAIUAAAAeAAAAAAAAAEcAAwCGAAAAAAAAAEcAAwCHAAAAAAAAAEcAAwCIAAAAAAAAAEcAAwCLAAAAAAAAABMAAgACAAAAIQADAAMAAAACAAAAFgADAAYAAAAgAAAAFwAEAAcAAAAGAAAAAgAAACAABAAIAAAABwAAAAcAAAAhAAQACQAAAAYAAAAIAAAAFwAEAA0AAAAGAAAABAAAACEABQAOAAAADQAAAAgAAAAIAAAAIAAEABMAAAAHAAAABgAAACsABAAGAAAAFQAAAAAAQEArAAQABgAAABsAAAAAAAAAKwAEAAYAAAAiAAAAAACgQRQAAgAjAAAAKwAEAAYAAAArAAAAAACAPxUABAAsAAAAIAAAAAAAAAArAAQALAAAAC0AAAAAAAAAKwAEACwAAAAxAAAAAQAAACwABQAHAAAAOQAAABsAAAAVAAAALAAFAAcAAABCAAAAFQAAABsAAAAgAAQATAAAAAAAAAAGAAAAOwAEAEwAAABNAAAAAAAAACwABQAHAAAAWAAAACsAAAArAAAAKwAEAAYAAABlAAAAAAAAQCsABAAGAAAAZwAAAAAAAD8sAAUABwAAAGgAAABnAAAAZwAAACAABABzAAAAAAAAAA0AAAA7AAQAcwAAAHQAAAAAAAAAOwAEAHMAAAB3AAAAAAAAACAABAB8AAAAAQAAAA0AAAA7AAQAfAAAAH0AAAABAAAAIAAEAIAAAAAAAAAABwAAADsABACAAAAAgQAAAAAAAAAgAAQAhAAAAAMAAAANAAAAOwAEAIQAAACFAAAAAwAAADYABQACAAAABAAAAAAAAAADAAAA+AACAAUAAAA7AAQACAAAAHsAAAAHAAAAOwAEAAgAAACGAAAABwAAADsABAAIAAAAiAAAAAcAAAA9AAQADQAAAH4AAAB9AAAATwAHAAcAAAB/AAAAfgAAAH4AAAAAAAAAAQAAAD0ABAAHAAAAggAAAIEAAACIAAUABwAAAIMAAAB/AAAAggAAAD4AAwB7AAAAgwAAAD0ABAAHAAAAhwAAAHsAAAA+AAMAhgAAAIcAAAA9AAQADQAAAIkAAAB9AAAATwAHAAcAAACKAAAAiQAAAIkAAAAAAAAAAQAAAD4AAwCIAAAAigAAADkABgANAAAAiwAAABEAAACGAAAAiAAAAD4AAwCFAAAAiwAAAP0AAQA4AAEANgAFAAYAAAALAAAAAAAAAAkAAAA3AAMACAAAAAoAAAD4AAIADAAAADsABAATAAAAFAAAAAcAAAA7AAQAEwAAABoAAAAHAAAAOwAEABMAAABVAAAABwAAAD4AAwAUAAAAFQAAAD0ABAAHAAAAFgAAAAoAAACOAAUABwAAABcAAAAWAAAAFQAAAD4AAwAKAAAAFwAAAD0ABAAHAAAAGAAAAAoAAAAMAAYABwAAABkAAAABAAAABAAAABgAAAA+AAMACgAAABkAAAA+AAMAGgAAABsAAAD5AAIAHAAAAPgAAgAcAAAA9gAEAB4AAAAfAAAAAAAAAPkAAgAgAAAA+AACACAAAAA9AAQABgAAACEAAAAaAAAAuAAFACMAAAAkAAAAIQAAACIAAAD6AAQAJAAAAB0AAAAeAAAA+AACAB0AAAA9AAQABgAAACUAAAAUAAAAhQAFAAYAAAAmAAAAJQAAABUAAAA+AAMAFAAAACYAAAA9AAQABwAAACcAAAAKAAAAjgAFAAcAAAAoAAAAJwAAABUAAAA+AAMACgAAACgAAAA9AAQABwAAACkAAAAKAAAADAAGAAcAAAAqAAAAAQAAAAQAAAApAAAAPgADAAoAAAAqAAAAQQAFABMAAAAuAAAACgAAAC0AAAA9AAQABgAAAC8AAAAuAAAADAAHAAYAAAAwAAAAAQAAADAAAAAvAAAAFQAAAEEABQATAAAAMgAAAAoAAAAxAAAAPQAEAAYAAAAzAAAAMgAAAAwABwAGAAAANAAAAAEAAAAwAAAAMwAAABUAAACFAAUABgAAADUAAAAwAAAANAAAAIMABQAGAAAANgAAACsAAAA1AAAAPQAEAAcAAAA3AAAACgAAAI4ABQAHAAAAOAAAADcAAAA2AAAAPgADAAoAAAA4AAAAPQAEAAcAAAA6AAAACgAAAIMABQAHAAAAOwAAADoAAAA5AAAAPgADAAoAAAA7AAAAPQAEAAcAAAA8AAAACgAAAAwABgAHAAAAPQAAAAEAAAAEAAAAPAAAAD4AAwAKAAAAPQAAAD0ABAAHAAAAPgAAAAoAAACDAAUABwAAAD8AAAA+AAAAOQAAAD4AAwAKAAAAPwAAAD0ABAAHAAAAQAAAAAoAAAAMAAYABwAAAEEAAAABAAAABAAAAEAAAAA+AAMACgAAAEEAAAA9AAQABwAAAEMAAAAKAAAAgwAFAAcAAABEAAAAQwAAAEIAAAA+AAMACgAAAEQAAAA9AAQABwAAAEUAAAAKAAAADAAGAAcAAABGAAAAAQAAAAQAAABFAAAAPgADAAoAAABGAAAAPQAEAAcAAABHAAAACgAAAIMABQAHAAAASAAAAEcAAABCAAAAPgADAAoAAABIAAAAPQAEAAcAAABJAAAACgAAAAwABgAHAAAASgAAAAEAAAAEAAAASQAAAD4AAwAKAAAASgAAAD0ABAAGAAAASwAAABoAAAA9AAQABgAAAE4AAABNAAAAvgAFACMAAABPAAAASwAAAE4AAAD3AAMAUQAAAAAAAAD6AAQATwAAAFAAAABRAAAA+AACAFAAAAD5AAIAHgAAAPgAAgBRAAAA+QACAB8AAAD4AAIAHwAAAD0ABAAGAAAAUwAAABoAAACBAAUABgAAAFQAAABTAAAAKwAAAD4AAwAaAAAAVAAAAPkAAgAcAAAA+AACAB4AAAA9AAQABwAAAFYAAAAKAAAAPQAEAAcAAABXAAAACgAAAAwABwAHAAAAWQAAAAEAAAAlAAAAVwAAAFgAAABRAAUABgAAAFoAAABZAAAAAAAAAFEABQAGAAAAWwAAAFkAAAABAAAAUAAFAAcAAABcAAAAWgAAAFsAAACDAAUABwAAAF0AAABWAAAAXAAAAAwABgAGAAAAXgAAAAEAAABCAAAAXQAAAD0ABAAGAAAAXwAAABQAAACIAAUABgAAAGAAAABeAAAAXwAAAD4AAwBVAAAAYAAAAD0ABAAGAAAAYQAAAFUAAAD+AAIAYQAAADgAAQA2AAUADQAAABEAAAAAAAAADgAAADcAAwAIAAAADwAAADcAAwAIAAAAEAAAAPgAAgASAAAAOwAEAAgAAABkAAAABwAAADsABAATAAAAawAAAAcAAAA7AAQACAAAAGwAAAAHAAAAPQAEAAcAAABmAAAADwAAAIMABQAHAAAAaQAAAGYAAABoAAAAjgAFAAcAAABqAAAAaQAAAGUAAAA+AAMAZAAAAGoAAAA9AAQABwAAAG0AAABkAAAAPgADAGwAAABtAAAAOQAFAAYAAABuAAAACwAAAGwAAAA+AAMAawAAAG4AAAA9AAQABgAAAG8AAABrAAAAugAFACMAAABwAAAAbwAAABsAAAD3AAMAcgAAAAAAAAD6AAQAcAAAAHEAAAByAAAA+AACAHEAAAA9AAQADQAAAHUAAAB0AAAA/gACAHUAAAD4AAIAcgAAAD0ABAANAAAAeAAAAHcAAAD+AAIAeAAAADgAAQA=';
